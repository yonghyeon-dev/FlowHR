generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  employees Employee[]
  payrollRuns PayrollRun[]
  deductionProfiles DeductionProfile[]
  auditLogs AuditLog[]
}

model Employee {
  id             String   @id
  organizationId String?
  name           String?
  email          String?
  active         Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  attendanceRecords AttendanceRecord[]
  workSchedules      WorkSchedule[]
  leaveRequests      LeaveRequest[]
  leaveBalance       LeaveBalanceProjection?
  payrollRuns        PayrollRun[]

  @@index([organizationId, active])
}

model Role {
  id          String   @id
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  permissions RolePermission[]

  @@index([name])
}

model RolePermission {
  roleId     String
  permission String
  createdAt  DateTime @default(now())

  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([roleId, permission])
  @@index([permission])
}

model AttendanceRecord {
  id           String   @id @default(cuid())
  employeeId   String
  employee     Employee @relation(fields: [employeeId], references: [id], onDelete: Restrict)
  checkInAt    DateTime
  checkOutAt   DateTime?
  breakMinutes Int      @default(0)
  isHoliday    Boolean  @default(false)
  notes        String?
  state        AttendanceState @default(PENDING)
  approvedAt   DateTime?
  approvedBy   String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model WorkSchedule {
  id           String   @id @default(cuid())
  employeeId   String
  employee     Employee @relation(fields: [employeeId], references: [id], onDelete: Restrict)
  startAt      DateTime
  endAt        DateTime
  breakMinutes Int      @default(0)
  isHoliday    Boolean  @default(false)
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([employeeId, startAt, endAt])
}

model LeaveRequest {
  id             String           @id @default(cuid())
  employeeId     String
  employee       Employee         @relation(fields: [employeeId], references: [id], onDelete: Restrict)
  leaveType      LeaveType        @default(ANNUAL)
  startDate      DateTime
  endDate        DateTime
  days           Int
  reason         String?
  state          LeaveRequestState @default(PENDING)
  decisionReason String?
  approvedAt     DateTime?
  approvedBy     String?
  rejectedAt     DateTime?
  rejectedBy     String?
  canceledAt     DateTime?
  canceledBy     String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  approvals      LeaveApproval[]

  @@index([employeeId, state, startDate, endDate])
}

model LeaveApproval {
  id        String             @id @default(cuid())
  requestId String
  action    LeaveDecisionAction
  actorId   String
  actorRole String
  reason    String?
  createdAt DateTime           @default(now())
  request   LeaveRequest       @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([requestId, createdAt])
}

model LeaveBalanceProjection {
  employeeId      String   @id
  employee        Employee @relation(fields: [employeeId], references: [id], onDelete: Restrict)
  grantedDays     Int      @default(15)
  usedDays        Int      @default(0)
  remainingDays   Int      @default(15)
  carryOverDays   Int      @default(0)
  lastAccrualYear Int?
  updatedAt       DateTime @updatedAt
}

model PayrollRun {
  id                     String   @id @default(cuid())
  organizationId         String?
  organization           Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  employeeId             String?
  employee               Employee? @relation(fields: [employeeId], references: [id], onDelete: SetNull)
  periodStart            DateTime
  periodEnd              DateTime
  state                  PayrollState @default(PREVIEWED)
  grossPayKrw            Int
  withholdingTaxKrw      Int?
  socialInsuranceKrw     Int?
  otherDeductionsKrw     Int?
  totalDeductionsKrw     Int?
  netPayKrw              Int?
  deductionBreakdown     Json?
  deductionProfileId     String?
  deductionProfileVersion Int?
  sourceRecordCount      Int      @default(0)
  confirmedAt            DateTime?
  confirmedBy            String?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@index([organizationId, periodStart, periodEnd])
}

model DeductionProfile {
  id                     String   @id
  organizationId         String?
  organization           Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  name                   String
  version                Int
  mode                   String
  withholdingRate        Decimal? @db.Decimal(5, 4)
  socialInsuranceRate    Decimal? @db.Decimal(5, 4)
  fixedOtherDeductionKrw Int      @default(0)
  active                 Boolean  @default(true)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@index([organizationId, active])
}

model AuditLog {
  id         String   @id @default(cuid())
  action     String
  entityType String
  entityId   String?
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  actorRole  String
  actorId    String?
  payload    Json?
  createdAt  DateTime @default(now())

  @@index([action, createdAt])
  @@index([entityType, entityId])
  @@index([organizationId, createdAt])
}

enum AttendanceState {
  PENDING
  APPROVED
  REJECTED
}

enum LeaveType {
  ANNUAL
  SICK
  UNPAID
}

enum LeaveRequestState {
  PENDING
  APPROVED
  REJECTED
  CANCELED
}

enum LeaveDecisionAction {
  APPROVED
  REJECTED
  CANCELED
}

enum PayrollState {
  PREVIEWED
  CONFIRMED
}
