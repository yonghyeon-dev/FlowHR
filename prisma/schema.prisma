generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model AttendanceRecord {
  id           String   @id @default(cuid())
  employeeId   String
  checkInAt    DateTime
  checkOutAt   DateTime?
  breakMinutes Int      @default(0)
  isHoliday    Boolean  @default(false)
  notes        String?
  state        AttendanceState @default(PENDING)
  approvedAt   DateTime?
  approvedBy   String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model LeaveRequest {
  id             String           @id @default(cuid())
  employeeId     String
  leaveType      LeaveType        @default(ANNUAL)
  startDate      DateTime
  endDate        DateTime
  days           Int
  reason         String?
  state          LeaveRequestState @default(PENDING)
  decisionReason String?
  approvedAt     DateTime?
  approvedBy     String?
  rejectedAt     DateTime?
  rejectedBy     String?
  canceledAt     DateTime?
  canceledBy     String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  approvals      LeaveApproval[]

  @@index([employeeId, state, startDate, endDate])
}

model LeaveApproval {
  id        String             @id @default(cuid())
  requestId String
  action    LeaveDecisionAction
  actorId   String
  actorRole String
  reason    String?
  createdAt DateTime           @default(now())
  request   LeaveRequest       @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([requestId, createdAt])
}

model LeaveBalanceProjection {
  employeeId      String   @id
  grantedDays     Int      @default(15)
  usedDays        Int      @default(0)
  remainingDays   Int      @default(15)
  carryOverDays   Int      @default(0)
  lastAccrualYear Int?
  updatedAt       DateTime @updatedAt
}

model PayrollRun {
  id                String   @id @default(cuid())
  employeeId        String?
  periodStart       DateTime
  periodEnd         DateTime
  state             PayrollState @default(PREVIEWED)
  grossPayKrw       Int
  withholdingTaxKrw Int?
  socialInsuranceKrw Int?
  otherDeductionsKrw Int?
  totalDeductionsKrw Int?
  netPayKrw         Int?
  deductionBreakdown Json?
  sourceRecordCount Int      @default(0)
  confirmedAt       DateTime?
  confirmedBy       String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model AuditLog {
  id         String   @id @default(cuid())
  action     String
  entityType String
  entityId   String?
  actorRole  String
  actorId    String?
  payload    Json?
  createdAt  DateTime @default(now())

  @@index([action, createdAt])
  @@index([entityType, entityId])
}

enum AttendanceState {
  PENDING
  APPROVED
  REJECTED
}

enum LeaveType {
  ANNUAL
  SICK
  UNPAID
}

enum LeaveRequestState {
  PENDING
  APPROVED
  REJECTED
  CANCELED
}

enum LeaveDecisionAction {
  APPROVED
  REJECTED
  CANCELED
}

enum PayrollState {
  PREVIEWED
  CONFIRMED
}
