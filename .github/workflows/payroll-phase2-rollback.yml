name: payroll-phase2-rollback

on:
  workflow_dispatch:
    inputs:
      confirm_phrase:
        description: "Type ROLLBACK_PHASE2 to continue"
        required: true
        type: string
      deploy_vercel:
        description: "Also sync Vercel flag and deploy production"
        required: true
        default: true
        type: boolean
      dry_run:
        description: "Validate workflow only (no flag mutation/deploy)"
        required: true
        default: false
        type: boolean
      reason:
        description: "Rollback reason"
        required: false
        type: string
  schedule:
    - cron: "30 0 * * 1"

permissions:
  contents: read
  actions: write
  issues: write

concurrency:
  group: payroll-phase2-rollback
  cancel-in-progress: false

jobs:
  rollback:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Resolve execution mode
        id: mode
        run: |
          if [ "${{ github.event_name }}" = "schedule" ]; then
            echo "dry_run=true" >> "$GITHUB_OUTPUT"
            echo "deploy_vercel=false" >> "$GITHUB_OUTPUT"
            echo "reason=scheduled rollback drill" >> "$GITHUB_OUTPUT"
          else
            echo "dry_run=${{ inputs.dry_run }}" >> "$GITHUB_OUTPUT"
            echo "deploy_vercel=${{ inputs.deploy_vercel }}" >> "$GITHUB_OUTPUT"
            if [ -n "${{ inputs.reason }}" ]; then
              echo "reason=${{ inputs.reason }}" >> "$GITHUB_OUTPUT"
            else
              echo "reason=manual rollback" >> "$GITHUB_OUTPUT"
            fi
          fi

      - name: Validate confirmation phrase
        if: ${{ github.event_name == 'workflow_dispatch' }}
        env:
          PHRASE: ${{ inputs.confirm_phrase }}
        run: |
          if [ "$PHRASE" != "ROLLBACK_PHASE2" ]; then
            echo "::error::Invalid confirm phrase. Expected ROLLBACK_PHASE2"
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4

      - name: Disable GitHub production phase2 flag
        if: ${{ steps.mode.outputs.dry_run != 'true' }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: gh variable set FLOWHR_PAYROLL_DEDUCTIONS_V1 --env production --body "false" -R "${{ github.repository }}"

      - name: Setup Node for Vercel sync
        if: ${{ steps.mode.outputs.deploy_vercel == 'true' && steps.mode.outputs.dry_run != 'true' }}
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Sync Vercel flag and deploy production
        if: ${{ steps.mode.outputs.deploy_vercel == 'true' && steps.mode.outputs.dry_run != 'true' }}
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_SCOPE: ${{ vars.VERCEL_SCOPE || 'yh-devs-projects' }}
          VERCEL_PROJECT_NAME: ${{ vars.VERCEL_PROJECT_NAME || 'flowhr' }}
        run: |
          if [ -z "$VERCEL_TOKEN" ]; then
            echo "::error::Missing production secret VERCEL_TOKEN"
            exit 1
          fi
          npx vercel@latest link --yes --project "$VERCEL_PROJECT_NAME" --scope "$VERCEL_SCOPE" --token "$VERCEL_TOKEN"
          echo "false" | npx vercel@latest env add FLOWHR_PAYROLL_DEDUCTIONS_V1 production --force --scope "$VERCEL_SCOPE" --token "$VERCEL_TOKEN"
          npx vercel@latest deploy --prod --yes --scope "$VERCEL_SCOPE" --token "$VERCEL_TOKEN"

      - name: Write summary
        run: |
          {
            echo "## Payroll Phase2 Rollback Result";
            echo "";
            echo "- Trigger: ${{ github.event_name }}";
            echo "- Dry run: ${{ steps.mode.outputs.dry_run }}";
            echo "- GitHub production flag target: FLOWHR_PAYROLL_DEDUCTIONS_V1=false";
            echo "- Vercel deploy executed: ${{ steps.mode.outputs.deploy_vercel }}";
            echo "- Reason: ${{ steps.mode.outputs.reason }}";
            echo "- Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}";
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Create issue on failure
        if: ${{ failure() }}
        uses: actions/github-script@v7
        env:
          ROLLBACK_REASON: ${{ steps.mode.outputs.reason }}
        with:
          script: |
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const title = `[rollback] payroll phase2 rollback failed (${context.runNumber})`;
            const body = [
              "Payroll phase2 rollback workflow failed.",
              "",
              `- Run: ${runUrl}`,
              `- Trigger: ${context.eventName}`,
              `- Reason: ${process.env.ROLLBACK_REASON || "n/a"}`
            ].join("\n");
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ["incident", "rollback", "phase2"]
            });

      - name: Notify Slack on failure
        if: ${{ failure() }}
        env:
          FLOWHR_ALERT_SLACK_WEBHOOK: ${{ secrets.FLOWHR_ALERT_SLACK_WEBHOOK }}
          FLOWHR_ALERT_TITLE: "[FlowHR] payroll-phase2-rollback failed"
          FLOWHR_ALERT_WORKFLOW: "payroll-phase2-rollback"
          FLOWHR_ALERT_RUN_URL: "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          FLOWHR_ALERT_REF: ${{ github.ref }}
          FLOWHR_ALERT_TRIGGER: ${{ github.event_name }}
          FLOWHR_ALERT_REASON: ${{ steps.mode.outputs.reason }}
        run: node scripts/ops/notify-slack-failure.mjs
