name: payroll-phase2-health

on:
  workflow_dispatch:
  schedule:
    - cron: "15 * * * *"

permissions:
  contents: read
  issues: write

jobs:
  health:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      - name: Validate required production secrets
        env:
          PRODUCTION_DATABASE_URL: ${{ secrets.FLOWHR_PRODUCTION_DATABASE_URL }}
          PRODUCTION_DIRECT_URL: ${{ secrets.FLOWHR_PRODUCTION_DIRECT_URL }}
        run: |
          missing=()
          for key in PRODUCTION_DATABASE_URL PRODUCTION_DIRECT_URL; do
            if [ -z "${!key}" ]; then
              missing+=("$key")
            fi
          done
          if [ ${#missing[@]} -gt 0 ]; then
            echo "::error::Missing required production secrets: ${missing[*]}"
            exit 1
          fi

      - name: Run phase2 health report
        env:
          DATABASE_URL: ${{ secrets.FLOWHR_PRODUCTION_DATABASE_URL }}
          DIRECT_URL: ${{ secrets.FLOWHR_PRODUCTION_DIRECT_URL }}
          FLOWHR_PHASE2_HEALTH_WINDOW_HOURS: ${{ vars.FLOWHR_PHASE2_HEALTH_WINDOW_HOURS || '24' }}
          FLOWHR_PHASE2_HEALTH_MIN_ATTEMPTS: ${{ vars.FLOWHR_PHASE2_HEALTH_MIN_ATTEMPTS || '1' }}
          FLOWHR_PHASE2_HEALTH_MAX_403_RATIO: ${{ vars.FLOWHR_PHASE2_HEALTH_MAX_403_RATIO || '0.20' }}
          FLOWHR_PHASE2_HEALTH_MAX_409_RATIO: ${{ vars.FLOWHR_PHASE2_HEALTH_MAX_409_RATIO || '0.20' }}
        run: npm run health:payroll:phase2 --if-present

      - name: Create issue on failure
        if: ${{ failure() }}
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const title = `[phase2-health] failed run ${context.runNumber}`;
            const body = [
              "Payroll phase2 health workflow failed.",
              "",
              `- Run: ${runUrl}`,
              `- Ref: ${context.ref}`,
              `- Trigger: ${context.eventName}`
            ].join("\n");
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ["incident", "phase2", "ops"]
            });

      - name: Notify alert webhook on failure
        if: ${{ failure() }}
        env:
          FLOWHR_ALERT_DISCORD_WEBHOOK: ${{ secrets.FLOWHR_ALERT_DISCORD_WEBHOOK }}
          FLOWHR_ALERT_SLACK_WEBHOOK: ${{ secrets.FLOWHR_ALERT_SLACK_WEBHOOK }}
          FLOWHR_ALERT_TITLE: "[FlowHR] payroll-phase2-health failed"
          FLOWHR_ALERT_WORKFLOW: "payroll-phase2-health"
          FLOWHR_ALERT_RUN_URL: "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          FLOWHR_ALERT_REF: ${{ github.ref }}
          FLOWHR_ALERT_TRIGGER: ${{ github.event_name }}
          FLOWHR_ALERT_RUNBOOK_URL: "https://github.com/${{ github.repository }}/blob/main/docs/production-rollout.md"
          FLOWHR_ALERT_BREAK_GLASS_URL: "https://github.com/${{ github.repository }}/blob/main/docs/break-glass.md"
          FLOWHR_ALERT_ROLLBACK_WORKFLOW_URL: "https://github.com/${{ github.repository }}/actions/workflows/payroll-phase2-rollback.yml"
        run: node scripts/ops/notify-slack-failure.mjs
