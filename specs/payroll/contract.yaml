owner: payroll-agent
version: 1.1.0
scope:
  in:
    - gross pay preview from approved attendance aggregates
    - payroll run trace and audit logging
    - deduction and tax contract artifacts for phase 2 rollout
  out:
    - country-specific tax engine implementation
    - external remittance
    - bank transfer execution
entities:
  - name: PayrollPeriod
    description: Payroll cycle boundary and state.
  - name: PayrollRun
    description: Payroll computation run with status and source snapshot.
  - name: PayrollItem
    description: Per-employee gross pay components.
api:
  auth:
    - role: payroll_operator
      permission: run payroll preview and confirm run
    - role: admin
      permission: full payroll operations
  endpoints:
    - method: POST
      path: /payroll/runs/preview
      description: Generate payroll gross pay preview for a period.
    - method: POST
      path: /payroll/runs/preview-with-deductions
      description: Generate payroll preview with deduction and tax components (phase2).
    - method: POST
      path: /payroll/runs/{runId}/confirm
      description: Confirm a payroll run.
  events:
    published:
      - name: payroll.calculated.v1
        description: Emitted when gross pay calculation is completed.
      - name: payroll.confirmed.v1
        description: Emitted when payroll run is confirmed.
      - name: payroll.deductions.calculated.v1
        description: Emitted when deduction/tax preview is calculated.
    consumed:
      - name: attendance.approved.v1
        description: Approved attendance aggregate input.
      - name: attendance.corrected.v1
        description: Correction-triggered recalculation input.
db_changes:
  migrations:
    - id: 202602130001_init_wi0001
      description: Create PayrollRun base table.
    - id: 202602130002_wi0001_api_extensions
      description: Extend PayrollRun and add AuditLog for payroll traceability.
    - id: 202602140003_payroll_phase2_contract_base
      description: Add additive deduction and net-pay trace fields to PayrollRun.
  backward_compatible: true
  notes: Phase2 extends payroll payload with additive nullable deduction fields.
invariants:
  - Gross pay is deterministic for same inputs and rules.
  - Net pay equals gross pay minus total deductions when phase2 fields are populated.
  - Payroll preview includes source attendance snapshot reference.
  - Recalculation after correction keeps immutable audit trail.
risk:
  permissions:
    - Unauthorized payroll run confirmation can lock wrong results.
  payroll_accuracy:
    - Misapplied overtime/night/holiday multipliers affect compensation.
    - Miscalculated deduction aggregation affects net pay accuracy.
  legal:
    - Payroll trace must support audit and dispute resolution.
test_plan:
  unit:
    - gross pay calculator with multiplier rules
    - deduction and net-pay aggregation formula
    - rounding behavior for KRW totals
  integration:
    - consume attendance.approved and produce payroll preview
    - preview-with-deductions and confirm flow
  regression:
    - replay GC-001 through GC-005 fixtures
  authorization:
    - payroll_operator role enforcement
  payroll_accuracy:
    - overtime/night/holiday category payout checks
    - deduction sum and net-pay deterministic checks
observability:
  audit_events:
    - payroll.calculated
    - payroll.deductions_calculated
    - payroll.confirmed
  metrics:
    - payroll_run_duration_ms
    - payroll_recalculation_count
    - payroll_deductions_preview_latency_ms
  logs:
    - payroll calculation error with run ID context
rollout:
  feature_flags:
    - name: payroll_preview_v1
      default: "off"
    - name: payroll_deductions_v1
      default: "off"
  migration_strategy: expand-contract
rollback:
  strategy: disable payroll_deductions_v1 and fallback to gross-only preview path
  max_recovery_time: 30m
deprecations: []
breaking_changes: false
consumer_impact: "Phase2 contract adds non-breaking deduction/net-pay fields and a feature-flagged preview endpoint."
references:
  - specs/common/time-and-payroll-rules.md
  - specs/payroll/phase2-compatibility-matrix.md
approval:
  spec_owner: payroll-agent
  qa_owner: qa-agent
