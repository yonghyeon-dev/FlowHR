owner: attendance-agent
version: 1.3.0
scope:
  in:
    - attendance record create/update
    - attendance record list query by period
    - correction approval/rejection flow
    - rejection reason capture in audit/event payload
    - approved/rejected attendance event publication
  out:
    - payroll tax and deduction
    - physical device protocol integration
entities:
  - name: AttendanceRecord
    description: Employee time entry with check-in/check-out and state.
  - name: AttendanceCorrection
    description: Requested or system-provided correction with approval state.
api:
  auth:
    - role: employee
      permission: create and list own attendance records
    - role: manager
      permission: approve/reject correction within assigned org
    - role: payroll_operator
      permission: list attendance records for payroll verification
    - role: admin
      permission: list attendance records without org restriction
  endpoints:
    - method: GET
      path: /attendance/records
      description: List attendance records filtered by period (from/to) and optional employeeId/state.
    - method: POST
      path: /attendance/records
      description: Create attendance record.
    - method: PATCH
      path: /attendance/records/{recordId}
      description: Update attendance record before approval.
    - method: POST
      path: /attendance/records/{recordId}/approve
      description: Approve attendance record or correction.
    - method: POST
      path: /attendance/records/{recordId}/reject
      description: Reject attendance record or correction with optional reason payload.
  events:
    published:
      - name: attendance.recorded.v1
        description: Emitted when attendance record is created.
      - name: attendance.approved.v1
        description: Emitted when attendance is approved and payable.
      - name: attendance.rejected.v1
        description: Emitted when attendance is rejected and excluded from payroll aggregation; includes optional reason.
      - name: attendance.corrected.v1
        description: Emitted when correction is approved.
    consumed:
      - name: employee.profile.updated.v1
        description: Employee metadata changed.
db_changes:
  migrations:
    - id: 202602130001_init_wi0001
      description: Create AttendanceRecord and PayrollRun base tables.
    - id: 202602130002_wi0001_api_extensions
      description: Extend AttendanceRecord with holiday/approval columns and add AuditLog.
  backward_compatible: true
  notes: Expand-contract pattern for future attendance payload updates.
invariants:
  - An approved attendance record cannot be silently overwritten.
  - A rejected attendance record cannot transition directly to approved.
  - Rejected attendance record is excluded from payroll aggregation.
  - Attendance timestamps are interpreted in Asia/Seoul.
  - Approved/rejected attendance emits exactly one final state event.
  - Employee attendance list queries are restricted to own employeeId.
risk:
  permissions:
    - Unauthorized approval could alter payroll amount.
    - Unauthorized rejection could omit payable minutes.
  payroll_accuracy:
    - Incorrect overnight boundary handling can misclassify payable minutes.
  legal:
    - Attendance history must remain auditable.
test_plan:
  unit:
    - timestamp normalization by timezone
    - correction state transition validation
    - rejection reason schema boundary (max 500 chars)
    - attendance list query parsing and role boundary guards
  integration:
    - create record to approve flow
    - create record to reject flow
    - reject flow with reason payload trace
    - reject flow invalid JSON body returns 400
    - reject flow oversized reason payload returns 400
    - list records by period returns expected rows
    - employee cross-employee list query is blocked with 403
    - manager list query requires employeeId (400)
  regression:
    - replay GC-001, GC-002, GC-003, GC-005
  authorization:
    - manager-only approval/rejection check
    - employee self-only list boundary check
  payroll_accuracy:
    - approved minutes match aggregation contract
observability:
  audit_events:
    - attendance.recorded
    - attendance.corrected
    - attendance.approved
    - attendance.rejected
  metrics:
    - attendance_approval_latency_ms
    - attendance_correction_count
    - attendance_rejection_count
  logs:
    - authorization denied logs for attendance approval
rollout:
  feature_flags:
    - name: attendance_v1
      default: "off"
  migration_strategy: expand-contract
rollback:
  strategy: disable attendance_v1 and route reads to previous adapter
  max_recovery_time: 30m
deprecations: []
breaking_changes: false
consumer_impact: "Contract v1.3.0 adds non-breaking attendance record list API (`GET /attendance/records`) with role boundary guards."
references:
  - specs/common/time-and-payroll-rules.md
  - work-items/WI-0009-attendance-rejection-flow.md
  - work-items/WI-0016-attendance-rejection-reason.md
  - work-items/WI-0017-attendance-reject-validation-guards.md
  - work-items/WI-0026-attendance-list-api.md
approval:
  spec_owner: attendance-agent
  qa_owner: qa-agent
