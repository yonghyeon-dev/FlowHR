owner: leave-agent
version: 1.3.0
scope:
  in:
    - leave request create/update/cancel flow
    - leave request list query by period overlap
    - leave approve/reject flow with audit trace
    - leave balance read model contract
    - annual leave accrual and carry-over settlement
  out:
    - external calendar synchronization
entities:
  - name: LeaveRequest
    description: Employee leave request with period, type, and status.
  - name: LeaveApproval
    description: Approval or rejection decision record with actor and reason.
  - name: LeaveBalanceProjection
    description: Read model of granted, used, remaining, and carry-over leave days.
api:
  auth:
    - role: employee
      permission: create/update and list own leave requests
    - role: manager
      permission: approve or reject leave requests within scope
    - role: payroll_operator
      permission: settle leave accrual cycle, read leave balances, and list leave requests for payroll review
    - role: admin
      permission: full leave operations
  endpoints:
    - method: GET
      path: /leave/requests
      description: List leave requests overlapping a period (from/to) with optional employeeId/state filters.
    - method: POST
      path: /leave/requests
      description: Create leave request.
    - method: PATCH
      path: /leave/requests/{requestId}
      description: Update pending leave request.
    - method: POST
      path: /leave/requests/{requestId}/approve
      description: Approve leave request.
    - method: POST
      path: /leave/requests/{requestId}/reject
      description: Reject leave request with reason.
    - method: POST
      path: /leave/requests/{requestId}/cancel
      description: Cancel pending leave request.
    - method: GET
      path: /leave/balances/{employeeId}
      description: Retrieve leave balance snapshot.
    - method: POST
      path: /leave/accrual/settle
      description: Settle annual leave accrual and carry-over for an employee.
  events:
    published:
      - name: leave.requested.v1
        description: Emitted when leave request is created.
      - name: leave.approved.v1
        description: Emitted when leave request is approved.
      - name: leave.rejected.v1
        description: Emitted when leave request is rejected.
      - name: leave.canceled.v1
        description: Emitted when pending leave is canceled.
      - name: leave.accrual.settled.v1
        description: Emitted when annual accrual settlement is applied.
    consumed:
      - name: employee.profile.updated.v1
        description: Employee org/profile metadata updates.
db_changes:
  migrations:
    - id: 202602140001_wi0002_leave_base
      description: Create leave requests, approvals, and balance projection tables.
    - id: 202602140002_wi0003_leave_accrual
      description: Add carry-over and accrual settlement trace fields to LeaveBalanceProjection.
  backward_compatible: true
  notes: Additive schema change. Existing balance rows default carry-over to 0.
invariants:
  - Final leave decisions are immutable and auditable.
  - Employee can mutate only own pending request.
  - Approved leave state is consumable for attendance/payroll downstream.
  - Same employee/year accrual settlement cannot be applied more than once.
  - Carry-over days are capped by policy and never negative.
  - Employee leave list queries are restricted to own employeeId.
risk:
  permissions:
    - Unauthorized approval or accrual settlement can alter payroll and staffing plans.
  payroll_accuracy:
    - Paid leave misclassification or incorrect carry-over cap can distort gross-pay totals.
  legal:
    - Leave decision history must be retained for dispute/audit handling.
test_plan:
  unit:
    - leave state transition guard validation
    - leave date normalization by Asia/Seoul
    - accrual settlement carry-over cap calculation
    - leave list query parsing and role boundary guards
  integration:
    - create/update/approve leave flow
    - reject flow with reason and audit
    - accrual settlement with duplicate-year protection
    - list leave requests by period overlap returns expected rows
    - employee cross-employee list query is blocked with 403
    - manager list query requires employeeId (400)
  regression:
    - overlap detection and boundary-date regressions
    - leave balance continuity after yearly settlement
  authorization:
    - employee self-service boundary check
    - manager/admin approval check
    - payroll_operator/admin-only accrual settlement check
    - employee self-only list boundary check
  payroll_accuracy:
    - approved paid leave classification for payroll consumer compatibility
    - carry-over cap and yearly reset rules
observability:
  audit_events:
    - leave.requested
    - leave.approved
    - leave.rejected
    - leave.canceled
    - leave.accrual_settled
  metrics:
    - leave_approval_latency_ms
    - leave_request_rejection_rate
    - leave_accrual_settlement_count
  logs:
    - leave authorization denied with actor role
    - leave accrual duplicate-year rejection logs
rollout:
  feature_flags:
    - name: leave_request_v1
      default: "off"
    - name: leave_approval_v1
      default: "off"
    - name: leave_accrual_v1
      default: "off"
  migration_strategy: expand-contract
rollback:
  strategy: disable leave flags and route accrual settlement to manual operations
  max_recovery_time: 30m
deprecations: []
breaking_changes: false
consumer_impact: "Contract v1.3.0 adds non-breaking leave request list API (`GET /leave/requests`) with role boundary guards."
references:
  - specs/common/time-and-payroll-rules.md
  - work-items/WI-0027-leave-list-api.md
approval:
  spec_owner: leave-agent
  qa_owner: qa-agent
